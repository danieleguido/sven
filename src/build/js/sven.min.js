/*

    Sven  
    ================================

a light django app which easily integrate text analysis with a powerful corpus management. - Version: 0.0.1 */
"use strict";angular.module("sven",["ngRoute","sven.filters","sven.services","sven.directives","sven.controllers","ui.bootstrap","monospaced.elastic","sven.D3"]).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.xsrfHeaderName="X-CSRFToken",b.defaults.xsrfCookieName="csrftoken",a.when("/",{templateUrl:"/static/partials/index.html",controller:"indexCtrl"}),a.when("/corpus/:id/documents",{templateUrl:"/static/partials/document.list.html",controller:"documentListCtrl",reloadOnSearch:!1}),a.when("/corpus/:id/segments",{templateUrl:"/static/partials/segment.list.html",controller:"segmentListCtrl"}),a.when("/corpus/:corpus_id/twitter/new",{templateUrl:"/static/partials/twitter.new.html",controller:"twitterCtrl",reloadOnSearch:!1}),a.when("/corpus/:corpus_id/document/new",{templateUrl:"/static/partials/document.new.html",controller:"documentCtrl"}),a.when("/corpus/:corpus_id/monitor",{templateUrl:"/static/partials/monitor.html",controller:"monitorCtrl"}),a.when("/document/:id",{templateUrl:"/static/partials/document.html",controller:"documentCtrl"}),a.when("/document",{templateUrl:"/static/partials/document.list.html",controller:"MyCtrl2"}),a.when("/profile",{templateUrl:"/static/partials/profile.html",controller:"profileCtrl"}),a.when("/search",{templateUrl:"/static/partials/search.html",controller:"searchCtrl"}),a.otherwise({redirectTo:"/"}),b.responseInterceptors.push(["$q","$log",function(a,b){return function(c){return c.then(function(a){return a.data.extra="Interceptor strikes back",a.data.meta&&a.data.meta.warnings&&b.info("warnings",a.data.meta.warnings),a},function(b){return 401===b.status?(b.data={status:"error",description:"Authentication required, or TIMEOUT session!"},b):a.reject(b)})}}])}]);var CTRL_LOADED="background: lime; color: #181818",STYLE_INFO="color: #b8b8b8",CONTROLLER_PARAMS_UPDATED="CONTROLLER_PARAMS_UPDATED",JOBS_RUNNING="JOBS_RUNNING",UPDATE_STATUS="UPDATE_STATUS",gimmesize=function(a){var b,a=angular.copy(a),c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c};angular.module("sven.controllers",["angularFileUpload"]).controller("layoutCtrl",["$scope","$rootScope","$location","$route","TagListFactory","ToastFactory",function(a,b,c,d,e,f){a.limit=25,a.offset=0,a.default_limit=25,a.default_offset=0,a.filters={},a.query="",a.numofpages=0,a.page=0,console.log("%c layoutCtrl ",CTRL_LOADED),a.ctrl="",a.toast=function(a,b,c){f.toast(a,b,c)},a.toast("sven loaded correctly",{position:"middle-center"}),a.setCorpus=function(a){b.selected_corpus_id=a},a.follow=function(){var a=Array.prototype.slice.call(arguments).join("/").replace(/\/+/g,"/");c.path(a)},a.search=function(b){b&&(a.query=b),console.log("%c search ","color:white; background-color:#383838",a.query),a.limit=a.default_limit,a.offset=a.default_offset,c.search({search:a.query})},a.pageto=function(b){var b=Math.max(0,Math.min(b,a.numofpages));console.log("page to",b),a.offset=b*a.limit,a.distill()},a.nextPage=function(){a.pageto(+a.page+1)},a.prevPage=function(){a.pageto(+a.page-1)},a.paginate=function(b){var b=b||{},c=[],d=0,e=0;a.total_count=b.total_count,console.log("$scope.paginate",a.limit,a.offset),a.numofpages=Math.floor((a.total_count-1)/a.limit),a.page=Math.floor(a.offset/a.limit),a.numofpages<10?(d=0,e=+a.numofpages):(e=Math.min(a.numofpages,a.page<10?10:a.page+5),d=e-10);for(var f=d;e+1>f;f++)c.push(f+1);a.pages=c,console.log("$scope.paginate",c)},a.suggestTags=function(a,b){return e.query({filters:'{"type":"'+a+'"}',search:b}).$promise.then(function(a){return a.objects})},a.distill=function(b){{var d=c.search().filters,e=c.search().search;c.search().orderby}if(e&&(a.query=e),d)try{var f=JSON.parse(d);a.filters=f}catch(g){console.log("%c! distill: filters failed ","color:white; background-color:crimson",g.message)}else a.filters={};a.howmanyfilters=gimmesize(a.filters),console.log("%c distill: loading filters ","color:white; background-color:green","query:",a.query,a.offset,a.limit),a.$broadcast(CONTROLLER_PARAMS_UPDATED,b)},a.setProperties=function(b,d){a.filters[b]=[d],console.log("%c filters setProperties",STYLE_INFO,b,d,a.filters),a.limit=a.default_limit,a.offset=a.default_offset,c.search({filters:JSON.stringify(a.filters)})},a.setProperty=function(b,d){a.filters[b]=d,console.log("%c filters setProperty","background: crimson; color: white",b,d,a.filters),c.search("filters",JSON.stringify(a.filters))},a.removeProperty=function(b,d){console.log("removing",b,d,"from filters"),delete a.filters[b],c.search({filters:JSON.stringify(a.filters)})},a.extendFilters=function(b){var c=angular.extend({},a.filters,b);return JSON.stringify(c)},b.$on("$routeChangeSuccess",function(b,c){console.log("%c    route change success",STYLE_INFO),a.filters={},a.limit=a.default_limit,a.offset=a.default_offset,a.ctrl=String(c.$$route.controller),a.distill()}),b.$on("$routeUpdate",function(){console.log("%c route updated",STYLE_INFO),a.distill()})}]).controller("indexCtrl",["$scope","D3Factory",function(a,b){a.values={timeline:[]},b.timeline({},function(b){a.values.timeline=b.values})}]).controller("notificationCtrl",["$rootScope","$scope","$log","$timeout","NotificationFactory",function(a,b,c,d,e){function f(){e.query({id:b.job_id},function(b){d(f,3617),a.$emit(JOBS_RUNNING,b)},function(a){c.info("ticking error",a),d(f,3917)})}f(),c.info("%c notificationCtrl ",CTRL_LOADED)}]).controller("corpusListCtrl",["$scope","CorpusListFactory",function(a,b){a.sync=function(){b.query(function(b){a.items=b.objects})},a.sync(),console.log("%c corpusListCtrl ",CTRL_LOADED)}]).controller("monitorCtrl",["$rootScope","$scope","$routeParams","$log","CommandFactory",function(a,b,c,d,e){d.info("%c monitorCtrl ",CTRL_LOADED),b.job={},a.$on(JOBS_RUNNING,function(a,d){b.corpus_id=c.corpus_id,b.log=d.log;for(var e in d.objects)if(d.objects[e].corpus.id==b.corpus_id){b.job=d.objects[e];break}}),b.setCorpus(c.corpus_id),b.start=function(a){e.query({id:c.corpus_id,cmd:a},function(){console.log(arguments)})}}]).controller("documentListCtrl",["$scope","$rootScope","$log","$upload","$routeParams","DocumentListFactory","DocumentTagsFactory",function(a,b,c,d,e,f,g){a.sync=function(){f.query({id:e.id,limit:a.limit,offset:a.offset,filters:a.filters},function(b){console.log(b),a.items=b.objects,a.paginate({total_count:b.meta.total_count})}),a.setCorpus(e.id)},a.uploadprogress=50,a.onFileSelect=function(f){c.info("onFileSelect",f),b.$emit(UPDATE_STATUS,"starting upload...");for(var g=0;g<f.length;g++){var h=f[g];a.upload=d.upload({url:"/api/corpus/"+e.id+"/upload",data:{myObj:a.myModelObj},file:h}).progress(function(c){a.uploadprogress=parseInt(100*c.loaded/c.total),b.$emit(UPDATE_STATUS,"uploading "+a.uploadprogress+"%"),console.log("percent: "+a.uploadprogress)}).success(function(){a.uploadprogress=100,b.$emit(UPDATE_STATUS,""),a.toast("upload completed",{position:"middle-center"}),a.sync()})}},a.$on(CONTROLLER_PARAMS_UPDATED,function(){"documentListCtrl"==a.ctrl&&a.sync()}),a.sync(),a.__adding_tag=!1,a.attachTag=function(b,c,d){g.save({id:d.id},{tags:c.name||c,type:b},function(){a.sync()}),a.__tag_candidate="",a.__adding_tag=!1,console.log(arguments,a.__tag_candidate)},c.info("%c documentListCtrl ",CTRL_LOADED,"loaded")}]).controller("documentCtrl",["$scope","$upload","$routeParams","$location","DocumentFactory","DocumentListFactory","DocumentSegmentsFactory","$log",function(a,b,c,d,e,f,g,h){a.document={mimetype:"text/html"},a.segments=[],a.sync=function(){e.query({id:c.id},function(b){a.document=b.object,g.query({id:c.id},function(b){console.log(b),a.segments=b.objects})})},a.save=function(){c.corpus_id&&(a.toast("saving link ..."),h.info("documentCtrl save()",angular.copy(a.document)),f.save({id:c.corpus_id},angular.copy(a.document),function(b){console.log(b),a.toast("link saved",{}),d.path("/document/"+b.object.id)}))},a.onFileSelect=function(d){for(var e=0;e<d.length;e++){var f=d[e];a.upload=b.upload({url:"/api/document/"+c.id+"/upload",file:f}).progress(function(b){a.uploadprogress=parseInt(100*b.loaded/b.total),console.log("percent: "+a.uploadprogress)}).success(function(b){a.uploadprogress=100,console.log("percent: "+a.uploadprogress),console.log(b),a.document.text=b.object.text})}},c.id&&a.sync(),c.corpus_id&&a.setCorpus(c.corpus_id),h.info("documentCtrl loaded")}]).controller("searchCtrl",["$scope","$log","DocumentListFactory",function(a,b){b.info("searchCtrl loaded")}]).controller("contextCtrl",["$scope",function(){}]).controller("profileCtrl",["$scope","ProfileFactory",function(a,b){a.sync=function(){b.query({},function(b){console.log(b),a.profile=b.object})},a.save=function(){b.save(angular.copy(a.profile),function(b){console.log("back to me",b),a.profile=b.object})},a.sync(),console.log("%c profileCtrl ",CTRL_LOADED)}]).controller("segmentListCtrl",["$scope","$routeParams","SegmentListFactory","SegmentFactory",function(a,b,c,d){a.sync=function(){c.query({id:b.id,limit:a.limit,offset:a.offset,filters:a.filters},function(b){console.log(b),a.items=b.objects,a.paginate({total_count:b.meta.total_count})}),a.setCorpus(b.id)},a.save=function(a){d.save({corpus_id:b.id,segment_id:a.id},{status:a.status,cluster:a.cluster},function(a){console.log(a)})},a.toggleStatus=function(b){b.status="IN"==b.status?"OUT":"IN",a.save(b)},a.$on(CONTROLLER_PARAMS_UPDATED,function(){"segmentListCtrl"==a.ctrl&&a.sync()}),a.sync(),console.log("%c segmentListCtrl ",CTRL_LOADED)}]).controller("statusCtrl",["$scope","$rootScope","$log",function(a,b,c){a.message="",b.$on(UPDATE_STATUS,function(b,c){a.message=c}),c.info("%c statusCtrl ",CTRL_LOADED)}]).controller("twitterCtrl",["$scope","$log","$routeParams","TwitterListFactory",function(a,b,c,d){a.item={},a.setCorpus(c.corpus_id),a.save=function(){d.save({},{corpus:c.id,url:a.item.url},function(b){a.toast("twitter account added to queue !"),console.log(b)})},b.info("%c twitterCtrl ",CTRL_LOADED)}]).controller("blankCtrl",["$scope",function(){}]),angular.module("sven.directives",[]).directive("scrollToFixed",function(){return{restrict:"A",scope:{marginTop:"="},link:function(a,b){$(b).scrollToFixed({marginTop:a.marginTop||0})}}}).directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]),angular.module("sven.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]),angular.module("sven.services",["ngResource"]).factory("ToastFactory",function(){return{toast:function(a,b,c){c||(c={}),"object"==typeof b&&(c=b,b=void 0),void 0!=c.cleanup&&$().toastmessage("cleanToast");var d=$.extend({text:"<div>"+(b?"<h1>"+b+"</h1><p>"+a+"</p>":"<h1>"+a+"</h1>")+"</div>",type:"notice",position:"bottom-right",inEffectDuration:200,outEffectDuration:200,stayTime:1900},c);$().toastmessage("showToast",d)}}}).factory("D3Factory",function(a){return a("/api/d3/:vis",{},{timeline:{method:"GET",params:{vis:"timeline"}}})}).factory("NotificationFactory",function(a){return a("/api/notification",{},{query:{method:"GET"}})}).factory("CommandFactory",function(a){return a("/api/corpus/:id/start/:cmd",{},{launch:{method:"POST",params:{cmd:"@cmd",id:"@id"}}})}).factory("ProfileFactory",function(a){return a("/api/profile",{},{query:{method:"GET"},update:{method:"POST"}})}).factory("CorpusListFactory",function(a){return a("/api/corpus",{},{query:{method:"GET",isArray:!1},create:{method:"POST"}})}).factory("CorpusFactory",function(a){return a("/api/corpus/:id",{},{query:{method:"GET",params:{id:"@id"}},update:{method:"POST"}})}).factory("DocumentListFactory",function(a){return a("/api/corpus/:id/document",{},{query:{method:"GET",isArray:!1},save:{method:"POST",params:{id:"@id"}}})}).factory("DocumentFactory",function(a){return a("/api/document/:id",{},{query:{method:"GET",isArray:!1,params:{id:"@id"}}})}).factory("DocumentTagsFactory",function(a){return a("/api/document/:id/tag",{},{query:{method:"GET",isArray:!1,params:{id:"@id"}}})}).factory("DocumentSegmentsFactory",function(a){return a("/api/document/:id/segments",{},{query:{method:"GET",isArray:!1,params:{id:"@id"}}})}).factory("SegmentListFactory",function(a){return a("/api/corpus/:id/segment",{},{query:{method:"GET",isArray:!1,params:{id:"@id"}}})}).factory("SegmentFactory",function(a){return a("/api/corpus/:corpus_id/segment/:segment_id",{},{query:{method:"GET",isArray:!1,params:{corpus_id:"@corpus_id",segment_id:"@segment_id"}}})}).factory("TagListFactory",function(a){return a("/api/tag",{},{query:{method:"GET",isArray:!1}})}).factory("TwitterListFactory",function(a){return a("/twit/account",{},{query:{method:"GET",isArray:!1}})}).value("version","0.2");